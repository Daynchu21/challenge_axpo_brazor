@using BlazorApp.Constants
@using BlazorApp.Models

@* Reusable Accordion Component with Accessibility and Performance *@
<div class=" gap-4 flex flex-col rounded-lg overflow-hidden transition-all duration-300" @ref="_accordionRef">
    <div class="flex justify-between items-center pb-2 cursor-pointer select-none hover:bg-black/[0.02] border-b border-gray-200 focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2"
        @onclick="ToggleAccordion" @onkeydown="HandleKeyDown" tabindex="0" role="button">
        <h3 class="@AppConstants.CssClasses.SubsectionTitle" id="accordion-title-@_accordionId">
            @Title
        </h3>
        <button
            class="bg-transparent border-0 cursor-pointer p-1 flex items-center justify-center transition-transform duration-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-label="@AppConstants.AriaLabels.ToggleAccordion" aria-expanded="@IsExpanded.ToString().ToLower()"
            aria-controls="accordion-content-@_accordionId" @onclick:stopPropagation="true" type="button">
            <img src="@AppConstants.Icons.ChevronUp" alt="" aria-hidden="true"
                class="chevron-icon @(IsExpanded ? "expanded" : "collapsed")" width="24" height="24" />
        </button>
    </div>

    @if (IsExpanded)
    {
        <div class="accordion-root" id="accordion-content-@_accordionId" role="region"
            aria-labelledby="accordion-title-@_accordionId">
            @if (Items == null || !Items.Any())
            {
                <div class="text-gray-500 text-sm p-4">No items available</div>
            }
            else
            {
                @foreach (var item in Items)
                {
                    <div class="accordion-body @item.CustomCssClass">
                        <span class="accordion-text-bold" title="@item.Label">@item.Label:</span>

                        @if (!string.IsNullOrEmpty(item.Icon))
                        {
                            <span class="flex items-center gap-2 accordion-text-regular">
                                <img src="@item.Icon" alt="@item.Value" class="w-6 h-4 object-contain" width="24" height="16"
                                    loading="lazy" />
                                <span>@item.Value</span>
                            </span>
                        }
                        else
                        {
                            <span class="accordion-text-regular" title="@item.Value">@item.Value</span>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private ElementReference _accordionRef;
    private readonly string _accordionId = Guid.NewGuid().ToString("N")[..8];

    [Parameter, EditorRequired]
    public string Title { get; set; } = string.Empty;

    [Parameter, EditorRequired]
    public IEnumerable<ContractSummaryItem> Items { get; set; } = Enumerable.Empty<ContractSummaryItem>();

    [Parameter]
    public bool InitiallyExpanded { get; set; } = false;

    [Parameter]
    public EventCallback<bool> OnToggle { get; set; }

    private bool IsExpanded { get; set; }

    protected override void OnInitialized()
    {
        IsExpanded = InitiallyExpanded;
    }

    private async Task ToggleAccordion()
    {
        IsExpanded = !IsExpanded;

        if (OnToggle.HasDelegate)
        {
            await OnToggle.InvokeAsync(IsExpanded);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            await ToggleAccordion();
        }
    }
}